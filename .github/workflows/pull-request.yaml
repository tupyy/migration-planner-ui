name: Pull Request
on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
    branches:
      - main
      - "release/*"
jobs:
  semantic-commit-check:
    name: Validate PR title
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    env:
      SKIP_SEMANTIC_ACTORS: '["red-hat-konflux[bot]", "dependabot[bot]", "renovate[bot]"]'
    steps:
      # Skip semantic PR title validation for bot-generated PRs
      # Bots auto-generate titles like "Bump lodash from 4.0.0 to 4.1.0"
      - if: ${{ !contains(fromJSON(env.SKIP_SEMANTIC_ACTORS), github.actor) }}
        uses: amannn/action-semantic-pull-request@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            build
            chore
            ci
            docs
            feat
            fix
            perf
            refactor
            style
            test
  lint-and-format:
    needs: semantic-commit-check
    if: ${{ !github.event.pull_request.draft && (needs.semantic-commit-check.result == 'success' || needs.semantic-commit-check.result == 'skipped') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/install-dependencies
      - run: yarn check:all
  type-check:
    needs: semantic-commit-check
    if: ${{ !github.event.pull_request.draft && (needs.semantic-commit-check.result == 'success' || needs.semantic-commit-check.result == 'skipped') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/install-dependencies
      - run: yarn typecheck:all
  test:
    needs: semantic-commit-check
    if: ${{ !github.event.pull_request.draft && (needs.semantic-commit-check.result == 'success' || needs.semantic-commit-check.result == 'skipped') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/install-dependencies
      - run: yarn test:all
  build:
    needs: semantic-commit-check
    if: ${{ !github.event.pull_request.draft && (needs.semantic-commit-check.result == 'success' || needs.semantic-commit-check.result == 'skipped') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: ./.github/actions/install-dependencies
      - run: yarn build:all
